<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Validation System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.8rem;
      border-bottom: 3px solid #4b6cb7;
      padding-bottom: 10px;
    }
    button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .btn-primary { background: #4b6cb7; color: white; }
    .btn-primary:hover { background: #3a5a9c; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-small {
      width: auto;
      padding: 8px 16px;
      font-size: 0.9rem;
      display: inline-block;
    }
    input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1.1rem;
      margin-bottom: 15px;
    }
    input:focus { outline: none; border-color: #4b6cb7; }
    .qr-list { max-height: 500px; overflow-y: auto; margin-top: 20px; }
    .qr-item {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
    }
    .qr-item.invalid { background: #fee; border-color: #fca5a5; }
    .qr-item.valid { background: #d1fae5; border-color: #10b981; }
    .qr-display { flex-shrink: 0; background: white; padding: 10px; border-radius: 8px; }
    .qr-info { flex: 1; }
    .qr-id {
      font-family: monospace;
      font-size: 0.9rem;
      font-weight: 600;
      word-break: break-all;
      margin-bottom: 8px;
    }
    .status-valid { color: #10b981; font-weight: 600; }
    .status-invalid { color: #ef4444; font-weight: 600; }
    #video {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
      background: #000;
      display: none;
      object-fit: cover;
    }
    .video-container {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 8px;
      margin: 20px 0;
      min-height: 300px;
      overflow: hidden;
    }
    .scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 240px;
      height: 240px;
      transform: translate(-50%, -50%);
      border: 3px solid #4b6cb7;
      border-radius: 12px;
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: #4b6cb7;
      box-shadow: 0 0 10px #4b6cb7;
      animation: scanLine 2s linear infinite;
    }
    @keyframes scanLine {
      0% { top: 0; }
      100% { top: 236px; }
    }
    .scan-status {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      z-index: 11;
      text-align: center;
      width: 80%;
    }
    #canvas { display: none; }
    .result {
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 600;
      text-align: center;
    }
    .result.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .result.error {
      background: #fee;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    .info-box {
      background: #e0f2fe;
      border: 2px solid #0ea5e9;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.9rem;
      color: #0891b2;
    }
    .flex-row { display: flex; gap: 10px; }
    .flex-row button { width: 50%; }
    .hidden { display: none; }
    .text-center { text-align: center; }
    .menu-card {
      max-width: 500px;
      margin: 100px auto;
    }
    .stats {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
    }
    .back-btn {
      background: transparent;
      color: white;
      border: 2px solid white;
      width: auto;
      padding: 10px 20px;
      margin-bottom: 20px;
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    .config-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      transform: translateX(200%);
      animation: slideIn 0.3s forwards;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }
    @keyframes slideIn {
      to { transform: translateX(0); }
    }
    @keyframes slideOut {
      to { transform: translateX(200%); }
    }
    .fade-out {
      animation: slideOut 0.3s forwards;
    }
    .code-preview {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .code-preview img {
      max-width: 200px;
      border: 2px solid #4b6cb7;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="notification-container"></div>

  <script>
    // CONFIGURATION - Set your Supabase details here
    const SUPABASE_URL = localStorage.getItem('supabase_url') || '';
    const SUPABASE_KEY = localStorage.getItem('supabase_key') || '';
    
    // Storage implementation - Supabase or localStorage fallback
    const storage = {
      async get(key) {
        if (SUPABASE_URL && SUPABASE_KEY) {
          try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/qr_codes?id=eq.${key}`, {
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
              }
            });
            const data = await response.json();
            return data.length > 0 ? { key, value: data[0].data } : null;
          } catch (e) {
            console.error('Supabase error:', e);
            return null;
          }
        } else {
          const value = localStorage.getItem(key);
          return value ? { key, value } : null;
        }
      },
      async set(key, value) {
        if (SUPABASE_URL && SUPABASE_KEY) {
          try {
            await fetch(`${SUPABASE_URL}/rest/v1/qr_codes`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
              },
              body: JSON.stringify({ id: key, data: value })
            });
            return { key, value };
          } catch (e) {
            console.error('Supabase error:', e);
            localStorage.setItem(key, value);
            return { key, value };
          }
        } else {
          localStorage.setItem(key, value);
          return { key, value };
        }
      },
      async delete(key) {
        if (SUPABASE_URL && SUPABASE_KEY) {
          try {
            await fetch(`${SUPABASE_URL}/rest/v1/qr_codes?id=eq.${key}`, {
              method: 'DELETE',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
              }
            });
          } catch (e) {
            console.error('Supabase error:', e);
          }
        }
        localStorage.removeItem(key);
        return { key, deleted: true };
      },
      async list(prefix) {
        if (SUPABASE_URL && SUPABASE_KEY) {
          try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/qr_codes?id=like.${prefix}*`, {
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
              }
            });
            const data = await response.json();
            return { keys: data.map(item => item.id) };
          } catch (e) {
            console.error('Supabase error:', e);
            const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
            return { keys };
          }
        } else {
          const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
          return { keys };
        }
      }
    };

    // State
    let state = {
      page: 'menu',
      codes: [],
      newCodeData: '',
      scanResult: null,
      cameraError: '',
      isScanning: false,
      stream: null
    };

    // Show notification
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Load codes
    async function loadCodes() {
      try {
        const result = await storage.list('qr:');
        if (result && result.keys) {
          const codes = [];
          for (const key of result.keys) {
            try {
              const data = await storage.get(key);
              if (data) codes.push(JSON.parse(data.value));
            } catch (e) {}
          }
          codes.sort((a, b) => new Date(b.created) - new Date(a.created));
          state.codes = codes;
        }
      } catch (e) {
        console.log('No codes yet');
      }
    }

    // Generate QR Code
    async function generateQRCode() {
      const data = state.newCodeData.trim();
      if (!data) {
        showNotification('Please enter data', 'error');
        return;
      }

      const code = {
        id: 'QR-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        data: data,
        created: new Date().toISOString(),
        valid: true,
        scannedAt: null
      };

      await storage.set('qr:' + code.id, JSON.stringify(code));
      state.newCodeData = '';
      await loadCodes();
      render();
      
      showNotification('QR Code generated successfully!');
      
      setTimeout(() => {
        const el = document.getElementById('qr-' + code.id);
        if (el && window.QRCode) {
          new QRCode(el, {
            text: code.id,
            width: 100,
            height: 100
          });
        }
      }, 100);
    }

    // Download QR code as image
    function downloadQR(id) {
      const qrElement = document.getElementById('qr-' + id);
      if (!qrElement) return;
      
      const canvas = qrElement.querySelector('canvas');
      if (canvas) {
        const link = document.createElement('a');
        link.download = id + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }
    }

    // Delete code
    async function deleteCode(id) {
      if (!confirm('Delete this code?')) return;
      await storage.delete('qr:' + id);
      await loadCodes();
      render();
      showNotification('QR Code deleted');
    }

    // Download all QR codes as ZIP
    async function downloadAllQR() {
      showNotification('Click download button on each QR code to save it');
    }

    // Clear all
    async function clearAll() {
      if (!confirm('Delete ALL codes?')) return;
      for (const code of state.codes) {
        await storage.delete('qr:' + code.id);
      }
      await loadCodes();
      render();
      showNotification('All QR Codes deleted');
    }

    // Start scanner
    async function startScanner() {
      state.cameraError = '';
      state.scanResult = null;
      state.isScanning = true;

      if (!navigator.mediaDevices) {
        state.cameraError = 'Camera not supported';
        render();
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        state.stream = stream;
        render();
        
        // Get video element after render
        setTimeout(() => {
          const video = document.getElementById('video');
          if (video) {
            video.srcObject = stream;
            video.style.display = 'block';
            video.play().then(() => {
              console.log('Video playing');
              scanFrame();
              showNotification('Scanner active - point QR code at the frame');
            }).catch(e => {
              console.error('Play error:', e);
              state.cameraError = 'Could not start video: ' + e.message;
              state.isScanning = false;
              render();
              showNotification('Camera error: ' + e.message, 'error');
            });
          }
        }, 100);
        
      } catch (e) {
        console.error('Camera error:', e);
        if (e.name === 'NotAllowedError') {
          state.cameraError = 'Camera permission denied. Please allow camera access in browser settings.';
        } else {
          state.cameraError = 'Camera error: ' + e.message;
        }
        state.isScanning = false;
        render();
        showNotification(state.cameraError, 'error');
      }
    }

    // Stop scanner
    function stopScanner() {
      if (state.stream) {
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }
      state.isScanning = false;
      const video = document.getElementById('video');
      if (video) {
        video.srcObject = null;
        video.style.display = 'none';
      }
      render();
    }

    // Scan frame
    function scanFrame() {
      if (!state.isScanning) return;

      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const scanStatus = document.getElementById('scan-status');
      
      if (!video || !canvas || !scanStatus) {
        requestAnimationFrame(scanFrame);
        return;
      }

      const ctx = canvas.getContext('2d');

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = Math.min(video.videoWidth, 640);
        canvas.height = Math.min(video.videoHeight, 480);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        if (window.jsQR) {
          const code = jsQR(imageData.data, canvas.width, canvas.height, {
            inversionAttempts: 'dontInvert'
          });
          if (code && code.data) {
            scanStatus.textContent = "QR code detected! Validating...";
            validateCode(code.data);
            return;
          } else {
            scanStatus.textContent = "Scanning for QR codes...";
          }
        }
      }

      requestAnimationFrame(scanFrame);
    }

    // Validate code
    async function validateCode(scannedId) {
      stopScanner();

      try {
        const result = await storage.get('qr:' + scannedId);
        
        if (!result) {
          state.scanResult = { success: false, message: 'QR Code not found' };
          render();
          showNotification('QR Code not found', 'error');
          return;
        }

        const code = JSON.parse(result.value);

        if (!code.valid) {
          state.scanResult = { 
            success: false, 
            message: 'QR Code Already Used',
            scannedAt: code.scannedAt 
          };
          render();
          showNotification('This QR Code has already been used', 'error');
          return;
        }

        code.valid = false;
        code.scannedAt = new Date().toISOString();
        await storage.set('qr:' + code.id, JSON.stringify(code));

        state.scanResult = { 
          success: true, 
          message: '‚úÖ Valid Code Scanned!',
          data: code.data 
        };

        await loadCodes();
        render();
        showNotification('Valid QR Code! Marked as used.');
      } catch (e) {
        state.scanResult = { success: false, message: 'Error: ' + e.message };
        render();
        showNotification('Error: ' + e.message, 'error');
      }
    }

    // Render
    function render() {
      const app = document.getElementById('app');
      
      if (state.page === 'menu') {
        const dbStatus = SUPABASE_URL && SUPABASE_KEY ? 
          '‚úì Database Connected' : 
          '‚ö†Ô∏è Using Local Storage (Configure Database)';
        const dbColor = SUPABASE_URL && SUPABASE_KEY ? '#10b981' : '#f59e0b';
        
        app.innerHTML = `
          <div class="container">
            <div class="card menu-card">
              <h1>üé´ QR Code Validation System</h1>
              <p style="text-align: center; color: #e6e6e6; margin-bottom: 10px;">Single-use validation system</p>
              <p style="text-align: center; color: ${dbColor}; font-weight: 600; margin-bottom: 20px;">
                ${dbStatus}
              </p>
              ${!SUPABASE_URL || !SUPABASE_KEY ? `
                <div class="config-section">
                  <strong>‚öôÔ∏è Database Setup Required</strong>
                  <p style="font-size: 0.9rem; margin: 10px 0;">To sync across devices, configure Supabase database.</p>
                  <button class="btn-secondary btn-small" onclick="changePage('config')" style="width: 100%;">
                    Configure Database
                  </button>
                </div>
              ` : ''}
              <button class="btn-primary" onclick="changePage('generator')">üì± Generate QR Codes</button>
              <button class="btn-primary" onclick="changePage('validator')">üì∑ Scan & Validate</button>
              <div class="stats">
                <strong>Total Codes:</strong> ${state.codes.length} 
                (${state.codes.filter(c => c.valid).length} valid)
              </div>
              <button class="btn-secondary btn-small" onclick="refreshCodes()" style="margin-top: 15px; width: 100%;">
                üîÑ Refresh Codes
              </button>
            </div>
          </div>
        `;
      } else if (state.page === 'generator') {
        const codesHtml = state.codes.length === 0 
          ? '<p class="text-center" style="padding: 40px; color: #999;">No codes generated yet</p>'
          : state.codes.map(code => `
              <div class="qr-item ${code.valid ? 'valid' : 'invalid'}">
                <div class="qr-display" id="qr-${code.id}"></div>
                <div class="qr-info">
                  <div class="qr-id">${code.id}</div>
                  <div style="font-size: 0.9rem; margin: 5px 0;">Data: ${code.data}</div>
                  <div style="font-size: 0.8rem; color: #666;">Created: ${new Date(code.created).toLocaleString()}</div>
                  <div class="${code.valid ? 'status-valid' : 'status-invalid'}" style="margin: 8px 0;">
                    ${code.valid ? '‚úì Valid' : '‚úó Used on ' + new Date(code.scannedAt).toLocaleString()}
                  </div>
                  <button class="btn-primary btn-small" onclick="downloadQR('${code.id}')" style="margin-right: 5px;">üíæ Download</button>
                  <button class="btn-danger btn-small" onclick="deleteCode('${code.id}')">Delete</button>
                </div>
              </div>
            `).join('');

        app.innerHTML = `
          <div class="container">
            <button class="back-btn" onclick="changePage('menu')">‚Üê Back to Menu</button>
            <div class="card">
              <h2>üì± Generate QR Codes</h2>
              <input 
                type="text" 
                id="codeInput" 
                placeholder="Enter data (e.g., Ticket #123)"
                value="${state.newCodeData}"
              />
              <button class="btn-primary" onclick="handleGenerate()">Generate QR Code</button>
              <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                <h3>Generated Codes (${state.codes.length})</h3>
                ${state.codes.length > 0 ? '<button class="btn-danger btn-small" onclick="clearAll()">Clear All</button>' : ''}
              </div>
              <div class="qr-list">${codesHtml}</div>
            </div>
          </div>
        `;

        const input = document.getElementById('codeInput');
        if (input) {
          input.addEventListener('input', (e) => {
            state.newCodeData = e.target.value;
          });
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleGenerate();
          });
        }

        setTimeout(() => {
          state.codes.forEach(code => {
            const el = document.getElementById('qr-' + code.id);
            if (el && el.children.length === 0 && window.QRCode) {
              new QRCode(el, {
                text: code.id,
                width: 100,
                height: 100,
                colorDark: code.valid ? '#000' : '#666',
                colorLight: code.valid ? '#fff' : '#fee'
              });
            }
          });
        }, 100);
      } else if (state.page === 'validator') {
        const errorHtml = state.cameraError 
          ? `<div class="result error">${state.cameraError}</div>`
          : '';

        const resultHtml = state.scanResult 
          ? `<div class="result ${state.scanResult.success ? 'success' : 'error'}">
              <div style="font-size: 1.2rem; margin-bottom: 10px;">${state.scanResult.message}</div>
              ${state.scanResult.data ? '<div>Data: ' + state.scanResult.data + '</div>' : ''}
              ${state.scanResult.scannedAt ? '<div style="font-size: 0.9rem; margin-top: 8px;">Previously scanned: ' + new Date(state.scanResult.scannedAt).toLocaleString() + '</div>' : ''}
              <button class="btn-primary btn-small" onclick="resetScan()" style="margin-top: 15px;">Scan Another</button>
            </div>`
          : '';

        app.innerHTML = `
          <div class="container">
            <button class="back-btn" onclick="stopScanner(); changePage('menu');">‚Üê Back to Menu</button>
            <div class="card">
              <h2>üì∑ Scan & Validate</h2>
              ${errorHtml}
              <div class="video-container">
                <video id="video" autoplay playsinline muted></video>
                <div class="scan-overlay">
                  <div class="scan-frame">
                    <div class="scan-line"></div>
                  </div>
                  <div class="scan-status" id="scan-status">Initializing scanner...</div>
                </div>
              </div>
              <canvas id="canvas" width="640" height="480"></canvas>
              <div class="flex-row">>
                <button class="btn-primary" onclick="startScanner()" ${state.isScanning ? 'disabled' : ''}>
                  Start Camera
                </button>
                <button class="btn-secondary" onclick="stopScanner()" ${!state.isScanning ? 'disabled' : ''}>
                  Stop Camera
                </button>
              </div>
              ${resultHtml}
              <div class="info-box">
                <strong>Scanning Instructions:</strong>
                <ol style="margin-left: 20px; margin-top: 10px;">
                  <li>Click "Start Camera" and allow camera access</li>
                  <li>Position QR code within the scanning frame</li>
                  <li>You'll see real-time scanning status updates</li>
                  <li>Valid codes become invalid after successful scan</li>
                  <li>Already used codes will show an error</li>
                </ol>
              </div>
            </div>
          </div>
        `;
        
        // Update scan status if scanning
        if (state.isScanning) {
          setTimeout(() => {
            const scanStatus = document.getElementById('scan-status');
            if (scanStatus) scanStatus.textContent = "Scanning for QR codes...";
          }, 500);
        }
      } else if (state.page === 'config') {
        app.innerHTML = `
          <div class="container">
            <button class="back-btn" onclick="changePage('menu')">‚Üê Back to Menu</button>
            <div class="card">
              <h2>‚öôÔ∏è Database Configuration</h2>
              <div class="info-box">
                <strong>Setup Instructions:</strong>
                <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                  <li>Go to <a href="https://supabase.com" target="_blank" style="color: #4b6cb7;">supabase.com</a> and create a free account</li>
                  <li>Create a new project</li>
                  <li>Go to Settings ‚Üí API</li>
                  <li>Copy the "Project URL" and "anon public" API key</li>
                  <li>In SQL Editor, run this query:<br>
                    <code style="display: block; background: #e0f2fe; padding: 10px; margin-top: 5px; border-radius: 4px; overflow-x: auto; margin-top: 10px;">
CREATE TABLE qr_codes (<br>
&nbsp;&nbsp;id TEXT PRIMARY KEY,<br>
&nbsp;&nbsp;data TEXT NOT NULL,<br>
&nbsp;&nbsp;created_at TIMESTAMP DEFAULT NOW()<br>
);<br>
<br>
ALTER TABLE qr_codes ENABLE ROW LEVEL SECURITY;<br>
<br>
CREATE POLICY "Enable all access" ON qr_codes<br>
FOR ALL USING (true) WITH CHECK (true);
                    </code>
                  </li>
                </ol>
              </div>
              
              <h3 style="margin-top: 30px; margin-bottom: 15px;">Enter Your Supabase Details:</h3>
              <input 
                type="text" 
                id="supabaseUrl" 
                placeholder="Supabase URL (e.g., https://xxx.supabase.co)"
                value="${localStorage.getItem('supabase_url') || ''}"
              />
              <input 
                type="text" 
                id="supabaseKey" 
                placeholder="Supabase API Key (anon public)"
                value="${localStorage.getItem('supabase_key') || ''}"
              />
              <button class="btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
              <button class="btn-danger" onclick="clearConfig()">üóëÔ∏è Clear Configuration</button>
            </div>
          </div>
        `;
      }
    }

    function changePage(page) {
      state.page = page;
      render();
    }

    function handleGenerate() {
      generateQRCode();
    }

    function resetScan() {
      state.scanResult = null;
      state.cameraError = '';
      render();
    }

    async function refreshCodes() {
      await loadCodes();
      render();
      showNotification('Codes refreshed! Total: ' + state.codes.length);
    }

    function saveConfig() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      
      if (!url || !key) {
        showNotification('Please enter both URL and API key', 'error');
        return;
      }
      
      localStorage.setItem('supabase_url', url);
      localStorage.setItem('supabase_key', key);
      showNotification('Configuration saved! Please refresh the page.');
      setTimeout(() => location.reload(), 2000);
    }

    function clearConfig() {
      if (confirm('Clear database configuration?')) {
        localStorage.removeItem('supabase_url');
        localStorage.removeItem('supabase_key');
        showNotification('Configuration cleared! Please refresh the page.');
        setTimeout(() => location.reload(), 2000);
      }
    }

    // Initialize
    loadCodes().then(render);
  </script>
</body>
</html>
